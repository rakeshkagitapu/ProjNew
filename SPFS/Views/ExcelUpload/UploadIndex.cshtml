@model SPFS.Models.RatingsViewModel

@{
    ViewBag.Title = "Uplaoded Ratings";
    var count = Model.RatingRecords != null ? Model.RatingRecords.Count : 0;
   

}

@using (Html.BeginForm(null, null, FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.isUpload)
    @Html.HiddenFor(m => m.SiteID)
    @Html.HiddenFor(m => m.Month)
    @Html.HiddenFor(m => m.Year)
    @Html.HiddenFor(m =>m.SiteName)
    @Html.Hidden("noOfRecords",@count)
    <h2>Ratings Page -Upload</h2>
    <hr />
    <div class="row col-md-12" style="padding-top:15px">
        <div class="col-md-6">
            <div class="form-group">
                @Html.LabelFor(model => model.SiteID, new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Model.SiteName
                </div>
            </div>

        </div>
        <div class="col-md-6">
            <div class="form-group col-md-6">
                @Html.LabelFor(model => model.Month, new { @class = "control-label col-md-3" })
                <div class="col-md-9">
                      @*@Model.Month*@
                    @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(Model.Month)
                </div>
            </div>
            <div class="form-group form-group-tight col-md-6">
                @Html.LabelFor(model => model.Year, new { @class = "control-label col-md-3" })
                <div class="input-group">
                    @Model.Year
                </div>

            </div>

        </div>

    </div>

    <hr />


    if (count > 0)
    {

        <div id="output" class="col-md-12">
            @Html.Partial("_SupplierRatings", Model)
        </div>

        <br />
       
        <div class="row col-md-12">
            <div class="pull-left">
                <button type="button" value="Add New Supplier to Rate" class="btn btn-default btn-md btnAdd add-item ">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add Unrated Supplier
                </button>

            </div>
            <div class="pull-right">
                <a href="@Url.Action("Index","Home")" class="btn btn-danger" onclick="return confirm('Are you sure, all data will be lost')">
                    <span class="glyphicon glyphicon-remove"></span> Cancel
                </a>
                <button type="submit" value="Save" onclick="OnBeginPostBack_Save(this)" name="action:SaveData" class="btn btn-primary">
                    <span class="glyphicon glyphicon-floppy-save"></span> Save
                    
                </button>
                <button type="submit" value="Submit" onclick="OnBeginPostBack_Save(this)" name="action:SubmitData" class="btn btn-primary">
                    <span class="glyphicon glyphicon-send"></span> Submit Ratings

                </button>
               
            </div>

        </div>

        <div id="popSup" style="overflow: auto;visibility:hidden">

            <div class="row col-md-12" style="margin-top: 10px">
                <div class="row">
                    <div class="col-md-10 input-group">
                        @*@Html.Label("Search by")*@

                        @Html.TextBox("search", "", new { @class = "form-control", id = "SupplierID", maxlength = "30", placeholder = "Search by Supplier Name ..." })
                        <span class="input-group-btn">
                            <button id="btnFilter" type="button" value="Search" class="btn btn-primary ">
                                <span class="glyphicon glyphicon-search"></span>
                            </button>
                        </span>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary btnOK"  disabled>
                            <span class="glyphicon glyphicon-floppy-save"></span>
                            <span>OK</span>
                        </button>
                    </div>

                </div>
                <br />
                <div class="row">
                    <div class="col-md-9">
                        <div class="form-group">
                            @Html.DropDownList("selectSuppliers", ViewBag.Suppliers as IEnumerable<SelectListItem>, new { @class = "form-control", style = "width: 500px ; border-radius:5px", size = 10, id = "selectSupplierID" })
                        </div>
                    </div>

                </div>

            </div>

        </div>
    }
}
<script type="text/javascript">
    $(document).ready(function () {


        var CID = $("#SelectSupplierID option:selected").val();

        $('#SupplierID').change(function () {
            var SupName = $('#SupplierID').val();
            SearchSupplierByName(SupName);

        });

          //Sorting
         $(document).on("click", "#btnFilter", function () {
             var SupName = $('#SupplierID').val();
                SearchSupplierByName(SupName);

            });

            function SearchSupplierByName(SupName) {
                $.ajax({
                    url: '@Url.Action("GetSupplierbyName", "ExcelUpload")',
                    //Passes the content of an input up
                    data: { nameString: SupName },
                    contentType: "application/json; charset=utf-8",
                    type: 'GET',
                    async: false,
                    cache: true,

                    success: function (data) {
                        $('#selectSupplierID').find('option').remove();
                        $.each(data, function (i, optionData) {
                            $('#selectSupplierID').append($('<option></option>').val(optionData.Value).html(optionData.Text));
                        });
                    }
                });
            };

        $('.btnAdd').bind("click", function () {
               $('#popSup').css("visibility", "visible");
                $("#popSup").dialog('option', 'title', "Select Supplier");
                $("#popSup").dialog("open");
                $('.btnOK').prop('disabled', true);
            });

            //$('.btnAdd').bind("click", function () {
            //   $('#popSup').css("visibility", "visible");
            //    $("#popSup").dialog('option', 'title', "Select Supplier");
            //    $("#popSup").dialog("open");

            //});

            $('.btnOK').bind("click", function () {
                var selectedText = $("#selectSupplierID").find("option:selected").text();
                var selectedValue = $("#selectSupplierID").val();
                var tableRow = $("#ratings tr td:nth-child(1)").filter(function () {
                    return $(this).is(":contains('" + selectedValue + "')");
                }).closest("tr");
                if (tableRow.length > 0) {
                    $("#ratings").find('tr').removeClass('active');
                    var oldrec = $("#selectedCid").closest('tr').attr("id", "");
                    $("#popSup").closest('.ui-dialog-content').dialog("close");
                    ShowDialogBox('Warning', 'Supplier exists please check.', 'Ok', '', '', null);
                    var row = tableRow.addClass('active');
                    row.attr("id", "selectedCid");

                    var container = $('tbody');
                    var scrollTo = $('#selectedCid');

                    container.animate({
                        scrollTop: (scrollTo.offset().top - 30) - container.offset().top + container.scrollTop()
                    });
                }
                else {
                    $.ajax({
                        url: '@Url.Action("AddRowReload", "ExcelUpload")',
                        //Passes the content of an input up
                        data: { CID: selectedValue }, //,SiteID:siteId,count:cont
                        contentType: "application/json; charset=utf-8",
                        type: 'GET',
                        cache: false,
                        dataType: 'html',
                        async: false,
                        success: function (data) {
                            var finaltext = selectedText + " Added to list";
                           
                            $("#selectSupplierID").find("option:selected").prop('selected', false);
                            $('#output').children().remove();
                            $('#output').html(data);
                            $('.btnOK').prop('disabled', true);
                            $("#popSup").closest('.ui-dialog-content').dialog("close");
                            $('#RatingSuppliers').selectpicker('refresh');
                        },
                        error: function (ts) { alert(ts.responseText) }
                    });
                }

            });

        $('#selectSupplierID').change(function () {
            //debugger
            if ($('#selectSupplierID').val() == '') {
                $('.btnOK').prop('disabled', true);
            } else {
                $('.btnOK').prop('disabled', false);
            }

        });
        $('#selectSupplierID').val('').trigger('change');

       
        $('#RatingSuppliers').change(function () {
            
            var cid = $("#RatingSuppliers option:selected").val();
            if (cid != "") {
                $("#ratings").find('tr').removeClass('active');
                var oldrec = $("#selectedCid").closest('tr').attr("id", "");
                //oldrec.attr("id", "");
                var tableRow = $("#ratings tr td:nth-child(1)").filter(function () {
                    return $(this).is(":contains('"+ cid +"')");
                   }).closest("tr");
                var row = tableRow.addClass('active');
               
                row.attr("id", "selectedCid");
                //$(".active").scrollIntoView();
                var container = $('tbody');
                var scrollTo = $('#selectedCid');

               
                container.animate({
                    scrollTop: (scrollTo.offset().top-30) - container.offset().top + container.scrollTop()
                });
               

                //var rowid = row.attr('id');
                //$("#selectRow" + rowid + "").scrollIntoView();
               

                //tableRow.addClass('active');
               //var table = $('table');
               ////var row= tableRow.addClass('active');
               // //var w = $(window);
               // var row = $("#ratings").find('tr')
               //           .removeClass('active')
               //           .is(":contains('"+ cid +"')")
               //           .addClass('active');
                //var w = $("#ratings");
                //if (row.length) {
                //    w.scrollTop(row.offset().top - (w.height() / 2));
                //}
            }

        });
     
        $('#popSup').dialog({
            autoOpen: false,
            width: 600,
            height: 300,
            resizable: false,
            title: 'Select Supplier',
            modal: true,
            open: function (event, ui) {

            }
        });
    });
    $(document).ajaxComplete(function () {
       

        $('#RatingSuppliers').change(function () {

            var cid = $("#RatingSuppliers option:selected").val();
            if (cid != "") {
                $("#ratings").find('tr').removeClass('active');
                var oldrec = $("#selectedCid").closest('tr').attr("id", "");
                //oldrec.attr("id", "");
                var tableRow = $("#ratings tr td:nth-child(1)").filter(function () {
                    return $(this).is(":contains('" + cid + "')");
                }).closest("tr");
                var row = tableRow.addClass('active');

                row.attr("id", "selectedCid");
                //$(".active").scrollIntoView();
                var container = $('tbody');
                var scrollTo = $('#selectedCid');


                container.animate({
                    scrollTop: (scrollTo.offset().top - 30) - container.offset().top + container.scrollTop()
                });


            }

        });
    });
</script>